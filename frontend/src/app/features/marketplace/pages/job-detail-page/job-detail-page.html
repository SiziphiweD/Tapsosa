<section class="card" *ngIf="job; else jobFallback">
  <!-- Job Header -->
  <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px;">
    <h1>
      {{ job.title }}
      <span class="chip" *ngIf="job.verified" style="font-size: 0.8rem; margin-left: 12px;">
        <i class="bi bi-patch-check-fill"></i> Verified
      </span>
    </h1>
  </div>
  
  <!-- Job Meta -->
  <p>
    <span><i class="bi bi-tag"></i> {{ job.category }}</span>
    <span><i class="bi bi-geo-alt"></i> {{ job.location }}</span>
    <span><i class="bi bi-currency-dollar"></i> R{{ job.minBudget.toLocaleString() }} â€“ R{{ job.maxBudget.toLocaleString() }}</span>
  </p>
  <p class="muted">
    <span><i class="bi bi-calendar"></i> Deadline: {{ job.bidDeadline | date:'mediumDate' }}</span>
    <span><i class="bi bi-hourglass-split"></i> {{ daysLeft(job.bidDeadline) }} days left</span>
    <span><i class="bi bi-chat"></i> {{ bids.length }} bid(s)</span>
  </p>

  <!-- Action Buttons -->
  <div class="actions">
    <button type="button" (click)="toggleSave()" [class.saved]="saved">
      <i class="bi" [ngClass]="saved ? 'bi-bookmark-fill' : 'bi-bookmark'"></i>
      {{ saved ? 'Saved' : 'Save Job' }}
    </button>
    <button type="button" disabled>
      <i class="bi bi-question-circle"></i> Ask Question
    </button>
    <a class="btn" *ngIf="user?.role === 'member'" [routerLink]="['/member/requests', job.id, 'bids']">
      <i class="bi bi-eye"></i> View All Bids
    </a>
  </div>

  <!-- Two Column Layout -->
  <div class="grid cols-2">
    <!-- Job Information -->
    <div class="card" style="padding: 1.5rem;">
      <h3><i class="bi bi-info-circle"></i> Job Information</h3>
      <div class="rows">
        <div class="row"><div>Category</div><div>{{ job.category }}</div></div>
        <div class="row"><div>Location</div><div>{{ job.location }}</div></div>
        <div class="row"><div>Start Date</div><div>{{ (job.startDate | date:'mediumDate') || 'TBD' }}</div></div>
        <div class="row"><div>Duration</div><div>{{ job.durationDays ? job.durationDays + ' days' : 'N/A' }}</div></div>
        <div class="row"><div>Requirements</div><div>{{ job.requirements || 'N/A' }}</div></div>
        <div class="row"><div>Certifications</div><div>{{ job.requiredCertifications?.join(', ') || 'None specified' }}</div></div>
        <div class="row"><div>Attachments</div><div>
          <span *ngIf="job.attachments?.length">ðŸ“Ž {{ job.attachments?.length }} file(s)</span>
          <span *ngIf="!job.attachments?.length">None</span>
        </div></div>
      </div>
    </div>

    <!-- Bid Form -->
    <div class="card" id="bid" style="padding: 1.5rem;">
      <h3><i class="bi bi-send"></i> Submit Your Bid</h3>
      
      <!-- Bid Status Message -->
      <div class="muted" *ngIf="bidStatusMessage" style="background: #fef9c3; padding: 12px; border-radius: var(--radius-md); color: #92400e; margin-bottom: 16px;">
        <i class="bi bi-info-circle"></i> {{ bidStatusMessage }}
      </div>

      <!-- Bid Form -->
      <form class="form" *ngIf="canBid">
        <!-- Section 1: Basic Information -->
        <h4><i class="bi bi-person"></i> Basic Information</h4>
        
        <label>
          <span>Supplier Name <small>*Required</small></span>
          <input
            name="supplierName"
            [(ngModel)]="supplierName"
            type="text"
            placeholder="Your company name"
            [readonly]="user && user.role === 'supplier'"
          />
        </label>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <label>
            <span>Bid Amount (R) <small>*Required</small></span>
            <input name="price" [(ngModel)]="price" type="number" placeholder="e.g. 22000" min="0" />
          </label>
          <label>
            <span>Delivery (days) <small>*Required</small></span>
            <input name="days" [(ngModel)]="days" type="number" placeholder="e.g. 3" min="1" />
          </label>
        </div>

        <label>
          <span>Earliest Start Date <small>*Required</small></span>
          <input name="startDate" [(ngModel)]="startDate" type="date" [min]="minBidDate" />
        </label>

        <!-- Section 2: Proposal -->
        <h4 style="margin-top: 16px;"><i class="bi bi-file-text"></i> Your Proposal</h4>

        <label>
          <span>Cover Message <small>*Required, max 200 chars</small></span>
          <textarea name="message" [(ngModel)]="message" rows="3" maxlength="200" placeholder="Why should they choose you?"></textarea>
          <span class="muted" style="text-align: right;">{{ (message || '').length }}/200</span>
        </label>

        <label>
          <span>Approach & Methodology <small>*Required</small></span>
          <textarea [(ngModel)]="approach" name="approach" rows="3" placeholder="Outline your approach to this project"></textarea>
        </label>

        <label>
          <span>Timeline & Milestones <small>*Required</small></span>
          <textarea [(ngModel)]="timeline" name="timeline" rows="3" placeholder="Key dates and deliverables"></textarea>
        </label>

        <label>
          <span>Team & Resources <small>*Required</small></span>
          <textarea [(ngModel)]="team" name="team" rows="3" placeholder="Who will work on this project?"></textarea>
        </label>

        <!-- Section 3: Commercial Terms -->
        <h4 style="margin-top: 16px;"><i class="bi bi-cash-coin"></i> Commercial Terms</h4>

        <label>
          <span>Payment Structure <small>*Required</small></span>
          <textarea [(ngModel)]="paymentStructure" name="paymentStructure" rows="3" placeholder="e.g. 50% upfront, 50% on completion"></textarea>
        </label>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <label>
            <span>Validity (days) <small>*Required</small></span>
            <input [(ngModel)]="validityDays" name="validityDays" type="number" placeholder="e.g. 14" min="1" />
          </label>
          <div></div>
        </div>

        <div class="checkbox-row">
          <input id="termsAccepted" type="checkbox" [(ngModel)]="termsAccepted" name="termsAccepted" />
          <label for="termsAccepted">I confirm that all information provided is accurate and I agree to the terms & conditions</label>
        </div>

        <!-- Section 4: Additional Information -->
        <h4 style="margin-top: 16px;"><i class="bi bi-paperclip"></i> Additional Information</h4>

        <label>
          <span>Pricing Breakdown</span>
          <textarea [(ngModel)]="pricingBreakdown" name="pricingBreakdown" rows="3" placeholder="Optional: line items, unit costs, etc."></textarea>
        </label>

        <label>
          <span>Risk Management</span>
          <textarea [(ngModel)]="risks" name="risks" rows="3" placeholder="Optional: potential risks and mitigations"></textarea>
        </label>

        <label>
          <span>Relevant Experience</span>
          <textarea [(ngModel)]="experience" name="experience" rows="3" placeholder="Optional: similar projects, references"></textarea>
        </label>

        <label>
          <span>Service Guarantees</span>
          <textarea [(ngModel)]="guarantees" name="guarantees" rows="3" placeholder="Optional: warranties, SLAs"></textarea>
        </label>

        <label>
          <span>Supporting Documents</span>
          <input type="file" multiple (change)="onFilesSelected($event)" />
          <span class="muted" *ngIf="uploadedFileNames.length > 0">
            <i class="bi bi-check-circle-fill" style="color: #166534;"></i> Selected: {{ uploadedFileNames.join(', ') }}
          </span>
        </label>

        <!-- Form Actions -->
        <div class="actions" style="margin-top: 24px;">
          <button type="button" (click)="saveDraft()" style="background: white; color: var(--color-text); border-color: var(--color-border);">
            <i class="bi bi-save"></i> Save Draft
          </button>
          <button type="button" [disabled]="!isValid" (click)="submitBid()" style="flex: 2;">
            <i class="bi bi-send"></i> Submit Bid
          </button>
        </div>
      </form>

      <!-- Success Toast -->
      <div class="toast success" *ngIf="submitted">
        <i class="bi bi-check-circle-fill"></i> Bid submitted successfully!
      </div>
    </div>
  </div>

  <!-- Bids List -->
  <div class="card" style="padding: 1.5rem;">
    <h3><i class="bi bi-chat"></i> All Bids ({{ bids.length }})</h3>
    <div class="bids">
      <div class="bid" *ngFor="let b of bids">
        <div class="title">
          <span>{{ b.supplierName }}</span>
          <span class="badge" *ngIf="job.chosenBidId === b.id">WINNING BID</span>
        </div>
        <div class="meta">
          <span><i class="bi bi-currency-dollar"></i> R{{ b.price.toLocaleString() }}</span>
          <span><i class="bi bi-clock"></i> {{ b.days }} days</span>
          <span><i class="bi bi-calendar"></i> {{ b.createdAt | date:'shortDate' }}</span>
        </div>
        <div class="msg">{{ b.message }}</div>
      </div>
      <div class="muted" style="text-align: center; padding: 2rem;" *ngIf="bids.length === 0">
        <i class="bi bi-inbox" style="font-size: 2rem; display: block; margin-bottom: 8px;"></i>
        No bids yet. Be the first to submit a bid!
      </div>
    </div>
  </div>

  <!-- Escrow Section (if awarded) -->
  <section class="card" *ngIf="job.escrow as e" style="padding: 1.5rem;">
    <h3><i class="bi bi-shield-lock"></i> Escrow Details</h3>
    <p class="muted" style="margin-bottom: 16px;">This job has been awarded. The winning bid is now in escrow.</p>
    <div class="escrow">
      <div class="row"><div>Gross Amount</div><div>R{{ e.gross.toLocaleString() }}</div></div>
      <div class="row"><div>TAPSOSA Fee (7%)</div><div>R{{ e.fee.toLocaleString() }}</div></div>
      <div class="row"><div>Net Payout</div><div>R{{ e.net.toLocaleString() }}</div></div>
      <div class="row">
        <div>Status</div>
        <div><span class="chip" [ngClass]="e.status">{{ e.status | uppercase }}</span></div>
      </div>
    </div>
  </section>

  <!-- Back Link -->
  <a class="link" [routerLink]="user?.role === 'member' ? '/member/requests' : '/supplier/jobs'">
    <i class="bi bi-arrow-left"></i> Back to {{ user?.role === 'member' ? 'My Requests' : 'Browse Jobs' }}
  </a>
</section>

<!-- Loading & Error States -->
<ng-template #jobFallback>
  <ng-container *ngIf="jobLoadFailed; else loadingJob">
    <section class="card" style="text-align: center; padding: 3rem;">
      <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #f59e0b; margin-bottom: 1rem;"></i>
      <h3>Job Unavailable</h3>
      <p class="muted" style="margin-bottom: 1.5rem;">This job could not be loaded. It may have been removed or is temporarily unavailable.</p>
      <a class="btn" routerLink="/supplier/jobs" style="display: inline-flex;">Back to Jobs</a>
    </section>
  </ng-container>
  <ng-template #loadingJob>
    <section class="card loading-card">
      <div class="spinner"></div>
      <div style="font-weight: 600;">Loading job details...</div>
    </section>
  </ng-template>
</ng-template>